#!/usr/bin/env node
const fs = require('fs');
const FILES = ['server/routes/navigation.ts','server/routes/database-query.ts','server/middleware/navigation-tracking.ts','server/middleware/route-validation.ts','server/routes/pipeline-automation.ts','server/routes/saintsal.ts'];
const PATTERNS = [{pattern:/\.where\(\s*\(\s*t\s*\)\s*=>\s*t\.(\w+)\s*===\s*([^)]+)\s*\)/g,replacement:(m,f,v,t)=>`.where(eq(${t}.${f}, ${v.trim()}))`,needsImport:['eq']},{pattern:/\.where\(\s*\(\s*t\s*\)\s*=>\s*t\.(\w+)\s*!==\s*([^)]+)\s*\)/g,replacement:(m,f,v,t)=>`.where(ne(${t}.${f}, ${v.trim()}))`,needsImport:['ne']},{pattern:/\.where\(\s*\(\s*t\s*\)\s*=>\s*t\.(\w+)\s*===\s*([^&]+)\s*&&\s*t\.(\w+)\s*===\s*([^)]+)\s*\)/g,replacement:(m,f1,v1,f2,v2,t)=>`.where(and(eq(${t}.${f1}, ${v1.trim()}), eq(${t}.${f2}, ${v2.trim()})))`,needsImport:['eq','and']}];
function guessTable(p,c){const m=c.match(/\.from\((\w+)\)/);if(m)return m[1];if(p.includes('navigation'))return 'pageMetadata';if(p.includes('route-validation'))return 'routeValidation';return 'users';}
function fixFile(f){console.log(`\nðŸ”§ ${f}`);if(!fs.existsSync(f)){console.log('âš ï¸  Not found');return false;}let c=fs.readFileSync(f,'utf-8');const o=c;let imp=new Set();const t=guessTable(f,c);PATTERNS.forEach(({pattern,replacement,needsImport})=>{const m=c.match(pattern);if(m){console.log(`   Found ${m.length}`);c=c.replace(pattern,(...a)=>{needsImport.forEach(i=>imp.add(i));return replacement(...a,t);});}});if(imp.size>0){const i=Array.from(imp).join(', ');if(!c.includes('drizzle-orm')){c=`import { ${i} } from 'drizzle-orm';\n${c}`;console.log(`   âœ… Added: ${i}`);}else{c=c.replace(/(import\s*{[^}]*})\s*from\s*['"]drizzle-orm['"]/,(m,ic)=>{const e=ic.match(/{\s*([^}]*)\s*}/)[1];const co=[...new Set([...e.split(',').map(s=>s.trim()),...imp])];return `import { ${co.join(', ')} } from 'drizzle-orm'`;});console.log(`   âœ… Updated: ${i}`);}}if(c!==o){fs.writeFileSync(f,c,'utf-8');console.log('   âœ… Fixed');return true;}return false;}
console.log('ðŸš€ Drizzle Fixer\n');let fixed=0;FILES.forEach(f=>{if(fixFile(f))fixed++;});console.log(`\n${'='.repeat(50)}\nâœ… Fixed ${fixed} files\n${'='.repeat(50)}`);
